#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

VERSION="1.1.0"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONFIG_DIR="$HOME/.config/grab"
CONFIG_FILE="$CONFIG_DIR/config"

# Source shared helpers (colors, logging, transcription, summarization, etc.)
source "$SCRIPT_DIR/lib/helpers.sh"

# Load or create config
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
    fi

    if [[ -z "${GRAB_DIR:-}" ]]; then
        # First run â€” ask where to save
        echo ""
        echo "ðŸ«³ grab â€” First time setup"
        echo ""
        echo "Where should grabbed files be saved?"
        echo "  Default: $HOME/Dropbox/ClawdBox"
        echo ""
        read -rp "Save directory (press Enter for default): " user_dir
        GRAB_DIR="${user_dir:-$HOME/Dropbox/ClawdBox}"

        # Expand ~ if used
        GRAB_DIR="${GRAB_DIR/#\~/$HOME}"

        mkdir -p "$CONFIG_DIR"
        echo "GRAB_DIR=\"$GRAB_DIR\"" > "$CONFIG_FILE"
        echo ""
        log "Config saved to $CONFIG_FILE"
        echo "  Files will be saved to: $GRAB_DIR"
        echo ""
    fi
}

load_config
BASE_DIR="$GRAB_DIR"
export BASE_DIR
export OPENAI_API_KEY="${OPENAI_API_KEY:-}"

# Source handlers
source "$SCRIPT_DIR/lib/tweet.sh"
source "$SCRIPT_DIR/lib/youtube.sh"
source "$SCRIPT_DIR/lib/reddit.sh"

# --- Main ---

URL="${1:-}"

if [[ -z "$URL" || "$URL" == "--help" || "$URL" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ "$URL" == "--version" || "$URL" == "-v" ]]; then
    echo "grab v${VERSION}"
    exit 0
fi

if [[ "$URL" == "--config" ]]; then
    echo "Current config: $CONFIG_FILE"
    echo "  Save directory: $GRAB_DIR"
    echo ""
    read -rp "New save directory (press Enter to keep current): " new_dir
    if [[ -n "$new_dir" ]]; then
        new_dir="${new_dir/#\~/$HOME}"
        mkdir -p "$CONFIG_DIR"
        echo "GRAB_DIR=\"$new_dir\"" > "$CONFIG_FILE"
        log "Updated save directory to: $new_dir"
    fi
    exit 0
fi

check_deps
check_api_key
mkdir -p "$BASE_DIR"

# Detect URL type â€” check for X articles first
if [[ "$URL" =~ (x\.com|twitter\.com)/.*/status/ ]]; then
    # Check if this tweet is actually an article
    article_check=$(yt-dlp --no-update --dump-json --no-download "$URL" 2>&1 || true)
    if echo "$article_check" | grep -q "x\.com/i/article/"; then
        article_id=$(echo "$article_check" | grep -oE 'article/[0-9]+' | head -1 | cut -d/ -f2)
        echo "ARTICLE_DETECTED:${article_id}:${URL}"
        info "This is an X Article â€” requires browser to extract content."
        info "Article ID: $article_id"
        exit 2
    fi
    grab_tweet "$URL"
elif [[ "$URL" =~ (youtube\.com|youtu\.be) ]]; then
    grab_youtube "$URL"
elif [[ "$URL" =~ (reddit\.com|redd\.it) ]]; then
    grab_reddit "$URL"
else
    # Try generic yt-dlp download
    info "Unknown URL type, attempting generic download..."
    SLUG=$(slugify "$(echo "$URL" | sed 's|https\?://||' | head -c 60)")
    FOLDER_NAME="download_${SLUG}_$(date_str)"
    OUT_DIR="$BASE_DIR/$FOLDER_NAME"
    mkdir -p "$OUT_DIR"

    yt-dlp --no-update --no-warnings \
        -o "$OUT_DIR/video.%(ext)s" \
        "$URL" 2>/dev/null && log "Downloaded to: $FOLDER_NAME/" || err "Download failed"
fi
